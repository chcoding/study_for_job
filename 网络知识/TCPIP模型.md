## TCP/IP模型

用于网络上不同设备之间的通信（相比较于同一台设备上的进程通信）

### 数据包结构

整个数据报文包含：HTTP数据头+TCP头+IP头+MAC头

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/12.jpg)



### 传输层（TCP|UDP）

封装应用层数据进行传输，**端口**（port）用来确定具体是哪个应用。与网络层设备之间的数据转发不同的是，传输层侧重于与应用层交互。

协议：TCP（传输控制协议）和UDP（不可靠）



#### 分块

传输层的数据包大小超过 MSS（TCP 最大报文段长度） ，就要将数据包分块。在 TCP 协议中，我们把每个分块称为一个 **TCP 段**（*TCP Segment*）。



### 网络层（IP协议）

负责数据包在网络设备之间的传输。

协议：IP协议



####  分片

IP 协议会将传输层的报文作为数据部分，再加上 IP 包头组装成 IP 报文，如果 IP 报文大小超过 **MTU**（以太网中一般为 1500 字节）就会**再次进行分片**，得到一个即将发送到网络的 IP 报文。

![MTU 与 MSS](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/11.jpg)

- `MTU`：一个网络包的最大长度，以太网中一般为 `1500` 字节。
- `MSS`：除去 IP 和 TCP 头部之后，一个网络包所能容纳的 TCP 数据的最大长度。



### 网络接口层

数据链路层和物理层（OSI7层）

网络接口层主要为网络层提供「链路级别」传输的服务，负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备。

协议：ARP协议



#### 封装格式

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost3@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%B5%AE%E7%82%B9/%E5%B0%81%E8%A3%85.png)

网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。





### 总结

1. 网络层是负责网络设备之间的数据包转发
2. 网络接口层负责实际物理链路层面的数据转发
3. 先由网络层的IP协议确定路由方向，然后通过链路层通过mac地址进行实际链路的传输。
4. 在网络包传输的过程中，**源 IP 和目标 IP 始终是不会变的，一直变化的是 MAC 地址**，因为需要 MAC 地址在以太网内进行**两个设备**之间的包传输。



### 新知识

Q：什么是以太网？

**以太网就是一种在「局域网」内，把附近的设备连接起来，使它们之间可以进行通讯的技术。**

电脑上的以太网接口，Wi-Fi接口，以太网交换机、路由器上的千兆，万兆以太网口，还有网线，它们都是以太网的组成部分。



Q：查看arp缓存内容

`arp -a`



#### 交换机特性

交换机属于二层网络设备，**交换机的端口不具有 MAC 地址**，但是会保存MAC 地址表，记录设备连接在交换机的哪个端口上（MAC地址和端口的映射）。



Q：当 MAC 地址表找不到指定的 MAC 地址会怎么样？

交换机无法判断应该把包转发到哪个端口，只能将包转发到除了源端口之外的所有端口上（广播），无论该设备连接在哪个端口上都能收到这个包。



如果接收方 MAC 地址是一个**广播地址**，那么交换机会将包发送到除源端口之外的所有端口。

- MAC 地址中的 `FF:FF:FF:FF:FF:FF`
- IP 地址中的 `255.255.255.255`



### 面试必知

Q：输入网址到载入网页发生了什么？

https://xiaolincoding.com/network/1_base/what_happen_url.html#%E5%AD%A4%E5%8D%95%E5%B0%8F%E5%BC%9F-http



Q:假设客户端有多个网卡，就会有多个 IP 地址，那 IP 头部的源地址应该选择哪个 IP 呢？

根据路由表中指定网卡对应的IP填入到IP报文中。



Q：路由器和交换机的区别？

- 因为**路由器**是基于 IP 设计的，俗称**三层**网络设备，路由器的各个端口都具有 MAC 地址和 IP 地址；
- 而**交换机**是基于以太网设计的，俗称**二层**网络设备，交换机的端口不具有 MAC 地址。
