## 协议

### ICMP协议

**网络层**协议

ICMP（Internet Control Message Protocol）Internet控制报文协议它是TCP/IP协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指**网络通不通、主机是否可达、路由是否可用**等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。



#### ICMP 包头格式

ICMP 报文是封装在 IP 包里面，它工作在网络层，是 IP 协议的助手。

![ICMP 报文](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/5.jpg)

ICMP 包头的**类型**字段，大致可以分为两大类：

- 一类是用于诊断的查询消息，也就是「**查询报文类型**」
- 另一类是通知出错原因的错误消息，也就是「**差错报文类型**」



查询报文主要是0（回送应答）和8（回送请求）

差错报文类型号是3（目标不可达）、4、5和11（超时，traceroute）



#### 应用

##### ping（查询报文，0和8）





##### traceroute（超时差错报文，11）

根据ICMP报文来实现的linux命令

1）用于追踪本机与目的IP之间经过的路由器

利用 IP 包的**生存期限** TTL从 `1` 开始按照顺序递增的同时发送 **UDP 包**，强制接收 **ICMP 超时消息**。



2）故意设置不分片，从而确定路径的 MTU

目标不可达的差错报文，有一个需要进行分片但设置了不分片位代码的错误。根据返回的icmp报文不断改变MTU大小，直到报文可达。



> Q：发送方如何知道发出的 UDP 包是否到达了目的主机呢？
>
> A：traceroute 在发送 `UDP` 包时，会填入一个**不可能的端口号**值作为 UDP 目标端口号（大于 `3000` ）。当目的主机，收到 UDP 包后，会返回 ICMP 差错报文消息，但这个差错报文消息的类型是「**端口不可达**」

